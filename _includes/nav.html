{%- assign groups = include.nodes | group_by:"category" | sort:"name" -%}

{%- if groups.size > 0 -%}
  <ul class="nav-list">
    {%- for group in groups -%}
      {%- if group.name != "" -%}
        <h4>{{ group.name }}</h4>
      {%- endif -%}

      {%- assign ordered_pages_list = group.items | where_exp:"item", "item.nav_order != nil" -%}
      {%- assign unordered_pages_list = group.items| where_exp:"item", "item.nav_order == nil" -%}
      {%- if site.nav_sort == 'case_insensitive' -%}
        {%- assign sorted_ordered_pages_list = ordered_pages_list | sort_natural:"nav_order" -%}
        {%- assign sorted_unordered_pages_list = unordered_pages_list | sort_natural:"title" -%}
      {%- else -%}
        {%- assign sorted_ordered_pages_list = ordered_pages_list | sort:"nav_order" -%}
        {%- assign sorted_unordered_pages_list = unordered_pages_list | sort:"title" -%}
      {%- endif -%}
      {%- assign pages_list = sorted_ordered_pages_list | concat: sorted_unordered_pages_list -%}

      {%- for node in pages_list -%}
        {%- include active.html node=node -%}
        <li class="nav-list-item{% if active %} active{% endif %}">
        <a href="{{ node.url | absolute_url }}" class="nav-list-link{% if active %} active{% endif %}">{{ node.title }}</a>

          {%- if active -%}
            {%- assign active = false -%}
            {%- assign children = hierarchy | where_exp:"item", "item.name == node.id" | map: "items" | first -%}
            {%- if children -%}
              {%- include nav.html nodes=children -%}
            {%- endif -%}
          {%- endif -%}
        </li>
      {%- endfor -%}

    {%- endfor -%}
  </ul>
{%- endif -%}
